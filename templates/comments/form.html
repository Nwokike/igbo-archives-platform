{% load static %}

<section class="modern-comment-section" id="comment-form-section">
    <div class="section-header">
        <h3 class="comment-section-title">
            <i class="fas fa-comments text-accent mr-2"></i>Discussion
        </h3>
        {% if not user.is_authenticated %}
        <span class="guest-notice-badge">Guest Mode</span>
        {% endif %}
    </div>

    <form method="post" action="{% url 'comments-post-comment' %}" class="modern-comment-form">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.path }}">
        {{ form.content_type }}
        {{ form.object_pk }}
        {{ form.timestamp }}
        {{ form.security_hash }}
        {{ form.parent }}

        {% if not user.is_authenticated %}
        <div class="guest-grid">
            <div class="floating-group">
                <input type="text" name="name" id="{{ form.name.id_for_label }}" placeholder="Name" required
                    value="{{ form.name.value|default:'' }}">
                <label for="{{ form.name.id_for_label }}">Name</label>
                {% if form.name.errors %}
                <span class="field-error">{{ form.name.errors.0 }}</span>
                {% endif %}
            </div>
            <div class="floating-group">
                <input type="email" name="email" id="{{ form.email.id_for_label }}" placeholder="Email" required
                    value="{{ form.email.value|default:'' }}">
                <label for="{{ form.email.id_for_label }}">Email</label>
                {% if form.email.errors %}
                <span class="field-error">{{ form.email.errors.0 }}</span>
                {% endif %}
            </div>
        </div>
        <p class="guest-login-hint">
            Already have an account? <a href="{% url 'account_login' %}?next={{ request.path }}">Log in here</a>
        </p>
        {% else %}
        <div class="logged-in-user-info">
            <div class="active-avatar">
                {% if user.profile_picture %}
                <img src="{{ user.profile_picture.url }}" alt="{{ user.get_display_name }}">
                {% else %}
                {{ user.get_display_name|slice:":1"|upper }}
                {% endif %}
            </div>
            <div class="user-meta-text">
                <span class="commenting-as">Commenting as</span>
                <span class="current-user-name">{{ user.get_display_name }}</span>
            </div>
        </div>
        {% endif %}

        <div class="floating-group">
            <textarea name="comment" id="{{ form.comment.id_for_label }}" placeholder="Share your thoughts..."
                required>{{ form.comment.value|default:'' }}</textarea>
            <label for="{{ form.comment.id_for_label }}">Share your thoughts...</label>
            {% if form.comment.errors %}
            <span class="field-error">{{ form.comment.errors.0 }}</span>
            {% endif %}
        </div>

        <div class="turnstile-wrapper mt-4">
            <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
            <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}" data-theme="auto"></div>
        </div>

        <div class="form-actions">
            <button type="submit" class="submit-btn" id="submit-comment">
                <span>Post Comment</span>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </form>
</section>