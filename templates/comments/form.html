{% load static %}

<section class="modern-comment-section mini-comment-form" id="comment-form-section">
    <div class="section-header mb-4">
        <h3 class="text-lg font-serif font-semibold flex items-center gap-2">
            <i class="fas fa-comments text-accent"></i> Discussion
        </h3>
        {% if not user.is_authenticated %}
        <span
            class="text-[10px] uppercase tracking-wider font-bold text-accent bg-accent/10 px-2 py-0.5 rounded-full">Guest
            Mode</span>
        {% endif %}
    </div>

    <form method="post" action="{% url 'comments-post-comment' %}" class="modern-comment-form">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.path }}">
        {{ form.content_type }}
        {{ form.object_pk }}
        {{ form.timestamp }}
        {{ form.security_hash }}
        {{ form.parent }}

        {% if not user.is_authenticated %}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
            <div class="floating-group">
                <input type="text" name="name" id="{{ form.name.id_for_label }}" placeholder="Name" required
                    class="w-full px-3 py-2 text-sm rounded-lg border border-border focus:border-accent outline-none transition-colors"
                    value="{{ form.name.value|default:'' }}">
                {% if form.name.errors %}
                <span class="text-xs text-red-500 mt-1">{{ form.name.errors.0 }}</span>
                {% endif %}
            </div>
            <div class="floating-group">
                <input type="email" name="email" id="{{ form.email.id_for_label }}" placeholder="Email" required
                    class="w-full px-3 py-2 text-sm rounded-lg border border-border focus:border-accent outline-none transition-colors"
                    value="{{ form.email.value|default:'' }}">
                {% if form.email.errors %}
                <span class="text-xs text-red-500 mt-1">{{ form.email.errors.0 }}</span>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="flex items-center gap-3 mb-3">
            <div
                class="w-8 h-8 rounded-full overflow-hidden bg-accent/10 flex items-center justify-center text-accent font-bold text-xs ring-2 ring-accent/20">
                {% if user.profile_picture %}
                <img src="{{ user.profile_picture.url }}" alt="{{ user.get_display_name }}"
                    class="w-full h-full object-cover">
                {% else %}
                {{ user.get_display_name|slice:":1"|upper }}
                {% endif %}
            </div>
            <div class="text-xs">
                <span class="text-text-muted">As</span>
                <span class="font-semibold text-text">{{ user.get_display_name }}</span>
            </div>
        </div>
        {% endif %}

        <div class="relative mb-3">
            <textarea name="comment" id="{{ form.comment.id_for_label }}" placeholder="Share your thoughts..." required
                rows="3"
                class="w-full px-4 py-3 text-sm rounded-xl border border-border focus:border-accent outline-none transition-all resize-none bg-surface-alt/30 focus:bg-white dark:focus:bg-surface-dark-alt min-h-[100px]">{{ form.comment.value|default:'' }}</textarea>
            {% if form.comment.errors %}
            <span class="text-xs text-red-500 mt-1">{{ form.comment.errors.0 }}</span>
            {% endif %}
        </div>

        <div class="turnstile-wrapper mb-4 scale-90 origin-left">
            <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
            <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}" data-theme="auto"></div>
        </div>

        <div class="flex justify-end">
            <button type="submit" class="btn-primary btn-sm flex items-center gap-2 group" id="submit-comment">
                <span>Post Comment</span>
                <i
                    class="fas fa-paper-plane text-[10px] group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform"></i>
            </button>
        </div>
    </form>
</section>