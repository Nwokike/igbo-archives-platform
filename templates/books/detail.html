{% extends 'base.html' %}
{% load static %}
{% load editorjs_renderer %}

{% block title %}{{ book.book_title }} - Recommended Books{% endblock %}

{% block meta_description %}{{ book.book_title }} by {{ book.author }} - {{ book.content|striptags|truncatewords:25 }}{%endblock %}

<!-- Open Graph / Facebook -->
{% block og_title %}{{ book.book_title }} by {{ book.author }} - Igbo Archives{% endblock %}
{% block og_description %}{{ book.content|striptags|truncatewords:50 }}{% endblock %}
{% block og_image %}{% if book.cover_image %}{{ request.scheme }}://{{ request.get_host }}{{ book.cover_image.url }}{%else %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/logos/logo-light.png' %}{% endif %}{% endblock %}

<!-- Twitter -->
{% block twitter_title %}{{ book.book_title }} by {{ book.author }}{% endblock %}
{% block twitter_description %}{{ book.content|striptags|truncatewords:50 }}{% endblock %}
{% block twitter_image %}{% if book.cover_image %}{{ request.scheme }}://{{ request.get_host }}{{ book.cover_image.url}}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/logos/logo-light.png' %}{% endif %}{%endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/editor.css' %}">
<link rel="stylesheet" href="{% static 'css/reviews.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/reviews.js' %}" defer></script>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

    <article class="lg:col-span-8">
        <header class="mb-6">
            <h1 class="font-serif text-display-lg text-dark-brown mb-2">{{ book.book_title }}</h1>
            <p class="text-xl text-vintage-beaver mb-4">by {{ book.author }}</p>

            {% if book.average_rating %}
            <div class="lg:hidden flex items-center gap-2 mb-4 text-vintage-gold">
                <span class="text-lg">â˜…</span>
                <span class="font-bold text-dark-brown">{{ book.average_rating|floatformat:1 }}</span>
                <span class="text-sm text-vintage-beaver">({{ book.rating_count }} reviews)</span>
            </div>
            {% endif %}
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            {% if book.cover_image %}
            <div class="md:col-span-1">
                <a href="{{ book.cover_image.url }}" target="_blank" class="block group">
                    <img src="{{ book.cover_image.url }}" alt="{{ book.book_title }}"
                        class="w-full rounded-lg shadow-soft group-hover:scale-[1.02] transition-transform duration-300">
                </a>
            </div>
            <div class="md:col-span-2">
                {% else %}
                <div class="md:col-span-3">
                    {% endif %}
                    <div class="card h-full">
                        <div class="card-body">
                            <h4 class="font-serif font-semibold text-dark-brown mb-3 border-b border-border/50 pb-2">
                                Book Details</h4>
                            <dl class="space-y-3 text-sm">
                                <div class="grid grid-cols-3">
                                    <dt class="font-medium text-vintage-beaver">Author</dt>
                                    <dd class="col-span-2 text-dark-umber font-medium">{{ book.author }}</dd>
                                </div>
                                {% if book.publisher %}
                                <div class="grid grid-cols-3">
                                    <dt class="font-medium text-vintage-beaver">Publisher</dt>
                                    <dd class="col-span-2 text-dark-umber">{{ book.publisher }}</dd>
                                </div>
                                {% endif %}
                                {% if book.publication_year %}
                                <div class="grid grid-cols-3">
                                    <dt class="font-medium text-vintage-beaver">Year</dt>
                                    <dd class="col-span-2 text-dark-umber">{{ book.publication_year }}</dd>
                                </div>
                                {% endif %}
                                {% if book.isbn %}
                                <div class="grid grid-cols-3">
                                    <dt class="font-medium text-vintage-beaver">ISBN</dt>
                                    <dd class="col-span-2 text-dark-umber font-mono">{{ book.isbn }}</dd>
                                </div>
                                {% endif %}
                            </dl>

                            {% if book.external_url %}
                            <a href="{{ book.external_url }}" target="_blank" rel="noopener noreferrer"
                                class="btn-primary mt-6 inline-flex items-center gap-2 w-full justify-center md:w-auto">
                                <i class="fas fa-book-open"></i>
                                View Book Source
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="prose prose-lg max-w-none mb-8" id="contentContainer">
                {{ book.content|render_editorjs }}
            </div>

            <div
                class="flex flex-wrap items-center gap-2 mb-8 p-3 bg-surface-alt/30 rounded-xl border border-border/50">
                {% if user == book.added_by %}
                <a href="{% url 'books:edit' book.slug %}" class="btn-primary btn-sm flex items-center gap-2">
                    <i class="fas fa-edit"></i> <span>Edit Recommendation</span>
                </a>
                {% endif %}

                <div class="ml-auto">
                    {% include 'partials/share_buttons.html' with title=book.book_title %}
                </div>
            </div>

            <hr class="border-sepia-pale/50 my-8">

            {% include 'partials/prev_next_navigation.html' with previous=previous_book next=next_book %}
            {% include 'partials/recommended_carousel.html' with recommended=related_books %}

    </article>

    <aside class="lg:col-span-4">
        <div class="sticky top-24">
            {% include 'books/partials/reviews_sidebar.html' %}
        </div>
    </aside>
</div>
{% endblock %}